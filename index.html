<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diaporama contrôlé</title>
  <style>
    :root{
      --bg:#ffeed5;
      --duration:10000ms; /* 10 s */
      --fade:1000ms;     /* fondu 1s réel (crossfade) */
      --radius:20px;
      --shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    html,body{height:100%;}
    body{
      margin:0; background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      color:#1f2937; display:grid; place-items:center;
    }
    .wrap{
      width:min(92vw,1100px);
      display:flex; flex-direction:column; align-items:center; gap:16px; padding:24px 16px 40px;
      transition: width .25s ease;
    }
    /* Mode agrandi (théâtre), sans plein écran */
    .wrap.theater{ width:min(98vw,1600px); }

    .stage{
      position:relative; width:100%; aspect-ratio:3/2; /* 1536x1024 = 3:2 */
      background:#fff8ee; border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; outline:1px solid rgba(0,0,0,.06);
    }
    /* Pile de deux calques pour un vrai crossfade */
    .stage img.layer{
      position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#fff8ee;
      opacity:0; transition:opacity var(--fade) linear; user-select:none; -webkit-user-drag:none;
    }
    .stage img.layer.show{ opacity:1; }

    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button{ appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:600; background:#111827; color:#fff; box-shadow:var(--shadow); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .hint{ font-size:.9rem; opacity:.75; }
    kbd{ background:#111827; color:#fff; padding:.2em .45em; border-radius:6px; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div id="stage" class="stage" aria-live="polite" aria-label="Diaporama">
      <img class="layer a show" id="layerA" alt="Diapositive A" />
      <img class="layer b" id="layerB" alt="Diapositive B" />
    </div>
    <div class="controls">
      <button id="sizeBtn" type="button" aria-label="Agrandir le lecteur">Agrandir</button>
      <span class="hint">
        Raccourcis : <kbd>Espace</kbd> pause/lecture • <kbd>←</kbd>/<kbd>→</kbd> précédent/suivant
      </span>
    </div>
  </div>

  <script>
  (function(){
    // --- Liste et règles ---
    const files = [
      "001","002","003","004","005","006","0061","0062","0063","007","008","009","010"
    ].map(n=>`./${n}.png`);

    const idx = {
      first: 0,
      stop1: files.indexOf("./006.png"),   // arrêt/pause sur 006
      gateStart: files.indexOf("./006.png"),
      gateEndNext: files.indexOf("./007.png"), // zone manuelle: 006..0063 (avant 007)
      resumeAt: files.indexOf("./007.png"),
      last: files.indexOf("./010.png")
    };

    const wrap = document.getElementById('wrap');
    const stage = document.getElementById('stage');
    const layerA = document.getElementById('layerA');
    const layerB = document.getElementById('layerB');
    const sizeBtn = document.getElementById('sizeBtn');

    let current = idx.first;         // commence sur 001
    let playing = false;             // lecture auto en cours ?
    let timer = null;                // setTimeout id
    let activeIsA = true;            // quel calque est à l'écran

    const activeLayer = () => activeIsA ? layerA : layerB;
    const inactiveLayer = () => activeIsA ? layerB : layerA;

    // Préchargement léger
    const preload = (i)=>{ if(files[i]){ const p=new Image(); p.src=files[i]; } };

    // Helpers règles
    const isInManualGate = (i)=> i>=idx.gateStart && i<idx.gateEndNext; // 006, 0061, 0062, 0063
    const isAutoAllowedAt = (i)=> (i>=1 && i<idx.stop1) || (i>=idx.resumeAt && i<idx.last);

    function crossfadeTo(src){
      const oldL = activeLayer();
      const newL = inactiveLayer();
      // Charger la prochaine image sur le calque caché, puis crossfade
      const onload = () => {
        // afficha ge : nouveau calque en fondu entrant, ancien en fondu sortant
        newL.classList.add('show');
        oldL.classList.remove('show');
        activeIsA = !activeIsA; // inverser les rôles une fois l'anim lancée
        newL.removeEventListener('load', onload);
      };
      newL.addEventListener('load', onload);
      newL.setAttribute('src', src);
    }

    function show(i){
      if(i<0) i=0; if(i>idx.last) i=idx.last;
      current = i;

      const nextSrc = files[current];
      // si premier affichage, mettre la première image directement
      if(!layerA.getAttribute('src') && !layerB.getAttribute('src')){
        layerA.setAttribute('src', nextSrc);
        layerA.classList.add('show');
      } else {
        // vrai crossfade 1s
        if(activeLayer().getAttribute('src') !== nextSrc){
          crossfadeTo(nextSrc);
        }
      }

      // Précharger la suivante
      preload(current+1);

      // Gestion des règles au moment de l'affichage
      clearTimer();

      if(current===idx.first){
        playing = false; // 001: en pause initiale
      } else if(current===idx.stop1){
        // Arrêt automatique sur 006
        playing = false;
      } else if(current===idx.resumeAt){
        // À 007 : reprise auto immédiate (si pas en fin de diapo)
        if(current<idx.last){
          playing = true; scheduleNext();
        }
      } else if(isAutoAllowedAt(current) && playing){
        scheduleNext();
      }

      updateSizeBtn();
    }

    function scheduleNext(){
      clearTimer();
      if(!isAutoAllowedAt(current)) return;
      timer = setTimeout(()=>{ go(+1, /*autoTick*/true); }, 7000);
    }
    function clearTimer(){ if(timer){ clearTimeout(timer); timer=null; } }

    function go(step=+1, autoTick=false){
      let next = current + step;
      if(next<0) next=0; if(next>idx.last) next=idx.last;
      if(autoTick && (next>current) && isInManualGate(next)){
        playing = false; show(current); return;
      }
      show(next);
    }

    // --- Contrôles clavier ---
    window.addEventListener('keydown', (e)=>{
      if([" ","Spacebar","Space"].includes(e.key)) e.preventDefault();
      switch(e.key){
        case ' ': case 'Spacebar': case 'Space':
          if(current===idx.first){
            show(current+1); playing = true; scheduleNext();
          } else if(isInManualGate(current)){
            // pas d'effet dans la zone manuelle
          } else if(current===idx.last){
            playing = false; clearTimer();
          } else {
            playing = !playing; if(playing){ scheduleNext(); } else { clearTimer(); }
          }
        break;
        case 'ArrowRight': go(+1); break;
        case 'ArrowLeft' : go(-1); break;
        default: break;
      }
    }, {passive:false});

    // --- Mode "Agrandir" (théâtre) ---
    function isTheater(){ return wrap.classList.contains('theater'); }
    function updateSizeBtn(){ sizeBtn.textContent = isTheater()? 'Réduire' : 'Agrandir'; }
    sizeBtn.addEventListener('click', ()=>{
      wrap.classList.toggle('theater');
      updateSizeBtn();
    });

    // --- Démarrage : afficher 001 (pausé) ---
    show(current);
  })();
  </script>
</body>
</html>